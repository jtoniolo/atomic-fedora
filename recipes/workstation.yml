# yaml-language-server: $schema=https://schema.blue-build.org/recipe-v1.json
name: atomic-workstation
description: ThinkPad T14 AMD developer & gaming workstation.

base-image: ghcr.io/ublue-os/aurora-dx
image-version: latest

modules:
  - type: files
    files:
      - source: system
        destination: /

  # --- FIX: Use 'containerfile' for inline commands instead of 'script' ---
  - type: containerfile
    snippets:
      - RUN systemctl mask power-profiles-daemon.service

  - type: dnf
    repos:
      files:
        - antigravity.repo
        # negativo17-multimedia removed - no F43 packages, aurora-dx has fedora-multimedia
      copr:
        - atim/starship
    install:
      packages:
        # --- AI CODING ASSISTANT ---
        - antigravity

        # --- THINKPAD T14 GEN 2 AMD HARDWARE ---
        - fwupd
        - radeontop
        - libva-utils
        - acpi
        - tlp
        - tlp-rdw

        # --- SHELL & CORE UTILITIES ---
        - micro
        - bat
        - ripgrep
        - p7zip
        - p7zip-plugins
        - ncdu
        - btop
        - duf

        # --- SYSTEM ADMIN ---
        - btrfs-assistant
        - snapper

        # --- KDE and GUI Apps ---
        - kio-gdrive

  # --- DISPLAYLINK SUPPORT ---
  # Install displaylink and akmod-evdi, build kmod, then extract and install manually
  # (akmods can't install via dnf in container builds, so we extract the built RPM)
  - type: containerfile
    snippets:
      - RUN dnf install -y --setopt=tsflags=noscripts displaylink akmod-evdi
      - RUN mkdir -p /var/log/akmods && rpm -qa | grep -E 'kernel|evdi' && ls -la /usr/src/akmods/
      - RUN akmods --force; AKMODS_EXIT=$?; echo "akmods exit code: $AKMODS_EXIT"; ls -la /var/cache/akmods/evdi/ || echo "No evdi cache dir"; cat /var/cache/akmods/evdi/*.log 2>/dev/null || echo "No log files"; exit $AKMODS_EXIT
      - RUN KVER=$(rpm -q kernel --qf '%{VERSION}-%{RELEASE}.%{ARCH}') && cd /tmp && rpm2cpio /var/cache/akmods/evdi/kmod-evdi-*.rpm | cpio -idmv && mkdir -p /lib/modules/${KVER}/extra/evdi && cp -v lib/modules/*/extra/evdi/evdi.ko* /lib/modules/${KVER}/extra/evdi/ && depmod -a ${KVER} && rm -rf /tmp/lib

  - type: systemd
    system:
      enabled:
        - sshd.service
        - cups.service
        - tailscaled.service
        - tlp.service
        - displaylink.service
        #- cockpit.socket

  - type: default-flatpaks
    configurations:
      - notify: true
        scope: system
        install:
          # --- BROWSERS ---
          - org.mozilla.firefox
          - com.google.Chrome
          - com.brave.Browser
          - com.microsoft.Edge

          # --- DEVELOPMENT ---
          - com.getpostman.Postman
          - io.dbeaver.DBeaverCommunity
          - com.mongodb.Compass
          - rest.insomnia.Insomnia
          - io.podman_desktop.PodmanDesktop

          # --- GAMING ---
          - org.prismlauncher.PrismLauncher
          - com.valvesoftware.Steam
          - com.heroicgameslauncher.hgl
          - net.lutris.Lutris
          - net.davidotek.pupgui2
          - org.gnome.Mahjongg

          # --- PRODUCTIVITY & TOOLS ---
          - com.github.tchx84.Flatseal
          - com.bitwarden.desktop
          - org.onlyoffice.desktopeditors
          - org.libreoffice.LibreOffice
          - com.nextcloud.desktopclient.nextcloud
          - com.actualbudget.actual
          - org.kde.kcalc
          - org.localsend.localsend_app
          - io.github.kolunmi.Bazaar
          - md.obsidian.Obsidian

          # --- COMMUNICATION & MESSAGING ---
          - com.discordapp.Discord
          - us.zoom.Zoom

          # --- MEDIA ---
          - org.videolan.VLC
          - com.obsproject.Studio
          - com.spotify.Client
          - com.plexamp.Plexamp
          - tv.plex.PlexDesktop

  - type: signing
